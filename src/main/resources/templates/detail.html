<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title th:text="${post.title}">글 상세</title>
    <style>
        body { max-width: 700px; margin: 2rem auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: #fafafa; padding: 0 1rem; }
        h1, h2, h3 { color: #222; }
        a { color: #0066cc; text-decoration: none; margin-right: 1rem; }
        a:hover { text-decoration: underline; }
        hr { border: none; border-top: 1px solid #ddd; margin: 1.5rem 0; }
        .post-meta { font-size: 0.9rem; color: #666; margin-bottom: 1rem; }
        .post-content { white-space: pre-line; margin-bottom: 1.5rem; }
        form.delete-form { display: inline-block; margin-left: 1rem; }
        button { cursor: pointer; background-color: #0066cc; border: none; color: white; padding: 0.4rem 1rem; border-radius: 4px; font-size: 1rem; transition: background-color 0.2s ease-in-out; }
        button:hover { background-color: #004999; }
        .comments-list { list-style: none; padding-left: 0; }
        .comments-list li { background: white; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .comment-time { font-size: 0.8rem; color: #999; margin-top: 0.5rem; display: block; }
        form.comment-form textarea { width: 100%; resize: vertical; font-size: 1rem; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 0.5rem; min-height: 80px; font-family: inherit; }
        form.comment-form button { display: block; width: 100%; font-weight: bold; }

        .top-buttons { text-align: right; margin-bottom: 1rem; }
        .top-buttons a { background-color: #007bff; color: white; padding: 0.4rem 0.8rem; border-radius: 5px; margin-left: 0.5rem; display: inline-block; }
        .top-buttons a.logout { background-color: #dc3545; }
    </style>
</head>
<body>

<!-- 최상단 버튼: 내 프로필 / 로그아웃 -->
<div class="top-buttons" th:if="${#authentication != null and #authentication.authenticated}">
    <a href="/myProfile">내 프로필</a>
    <a th:href="@{/logout}" class="logout">로그아웃</a>
</div>

<article>
    <header>
        <h1 th:text="${post.title}">글 제목</h1>
        <div class="post-meta">
            작성자: <strong th:text="${post.user != null ? post.user.email : '알 수 없음'}">작성자</strong> |
            <time th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">날짜</time> |
            조회수: <span th:text="${post.views}">0</span>
        </div>
    </header>

    <section class="post-content" th:text="${post.content}">글 내용</section>

    <nav>
        <a href="/posts">목록으로</a>
        <span th:if="${#authentication.principal?.user?.email == post.user?.email or #authorization.expression('hasRole(''ADMIN'')')}">
            <a th:href="@{'/posts/' + ${post.id} + '/edit'}">수정</a>
            <form th:action="@{'/posts/' + ${post.id}}" method="post" class="delete-form" onsubmit="return confirm('정말 삭제하시겠습니까?');">
                <input type="hidden" name="_method" value="delete" />
                <button type="submit">삭제</button>
            </form>
        </span>
    </nav>
</article>

<hr />
<section>
    <h2>댓글</h2>

    <div th:if="${#lists.isEmpty(comments)}">
        <p>댓글이 아직 없습니다.</p>
    </div>

    <ul class="comments-list" th:each="comment : ${post.comments}">
        <li>
            <p><strong th:text="${comment.user.email}">작성자</strong></p>
            <p th:text="${comment.content}">댓글 내용</p>
            <time class="comment-time" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">작성 시간</time>

            <form th:if="${#authentication.principal?.user?.email == comment.user.email}"
                  th:action="@{'/comments/' + ${comment.id}}" method="post"
                  onsubmit="return confirm('이 댓글을 삭제하시겠습니까?');"
                  class="delete-form">
                <input type="hidden" name="_method" value="delete" />
                <button type="submit">삭제</button>
            </form>
        </li>
    </ul>
</section>

<section th:if="${#authorization.expression('isAuthenticated()')}">
    <h3>댓글 작성</h3>
    <form th:action="@{/comments}" method="post" class="comment-form">
        <input type="hidden" name="postId" th:value="${post.id}" />
        <textarea name="content" placeholder="댓글을 입력하세요" required></textarea>
        <button type="submit">댓글 등록</button>
    </form>
</section>

</body>
</html>
